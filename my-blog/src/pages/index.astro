---
import Layout from '../layouts/Layout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import TagFilter from '../components/TagFilter.astro';
import GlassCard from '../components/GlassCard.astro';
import { base } from '../utils/base';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const categories = [...new Set(posts.map((p) => p.data.category))].sort();
const allTags = posts.flatMap((p) => p.data.tags);
---

<Layout title="Blog">
  <h1 class="page-title">Blog</h1>

  <section class="categories">
    <GlassCard class="category-header">
      <h2 class="section-label">Categories</h2>
      <div class="category-list">
        {categories.map((cat) => (
          <a href={`${base}category/${encodeURIComponent(cat)}`} class="category-pill">{cat}</a>
        ))}
      </div>
    </GlassCard>
  </section>

  <section class="articles-section">
    <h2 class="section-label">Articles</h2>
    <TagFilter tags={allTags} id="main-tag-filter" />
    <div class="article-grid" id="article-grid">
      {posts.map((post) => (
        <ArticleCard
          title={post.data.title}
          date={post.data.date}
          category={post.data.category}
          tags={post.data.tags}
          slug={post.id.replace(/\.md$/, '') || post.id}
        />
      ))}
    </div>
  </section>

  <script>
    const grid = document.getElementById('article-grid');
    const filter = document.getElementById('main-tag-filter');
    if (grid && filter) {
      const cards = grid.querySelectorAll('[data-category]');
      const buttons = filter.querySelectorAll('.tag-btn');

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const tag = (btn as HTMLButtonElement).dataset.tag;
          buttons.forEach((b) => b.setAttribute('data-active', (b as HTMLButtonElement).dataset.tag === tag ? 'true' : 'false'));
          cards.forEach((card) => {
            const tagList = (card.getAttribute('data-tags') || '').split(',');
            const show = !tag || tagList.includes(tag);
            (card as HTMLElement).style.display = show ? '' : 'none';
          });
        });
      });
    }
  </script>
</Layout>

<style>
  .page-title {
    margin: 0 0 2rem;
    font-size: 2rem;
    font-weight: 600;
  }

  .section-label {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin: 0 0 0.75rem;
  }

  .categories {
    margin-bottom: 2.5rem;
  }

  .category-header {
    padding: 1.25rem 1.5rem;
  }

  .category-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .category-pill {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border-subtle);
    border-radius: var(--glass-radius-sm);
    font-size: 0.9rem;
    transition: background var(--transition-fast), border-color var(--transition-fast);
  }

  .category-pill:hover {
    background: var(--accent-soft);
    border-color: var(--accent);
  }

  .article-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
