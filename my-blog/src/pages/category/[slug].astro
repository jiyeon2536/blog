---
import Layout from '../../layouts/Layout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import TagFilter from '../../components/TagFilter.astro';
import { base } from '../../utils/base';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const slugs = [...new Set(posts.map((p) => p.data.category))];
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const allPosts = await getCollection('blog');
const posts = allPosts
  .filter((p) => p.data.category === slug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const allTags = posts.flatMap((p) => p.data.tags);
---

<Layout title={`${slug} - Blog`}>
  <a href={base} class="back-link">‚Üê Back to home</a>
  <h1 class="page-title">{slug}</h1>

  <section class="articles-section">
    <TagFilter tags={allTags} id="category-tag-filter" />
    <div class="article-grid" id="article-grid">
      {posts.map((post) => (
        <ArticleCard
          title={post.data.title}
          date={post.data.date}
          category={post.data.category}
          tags={post.data.tags}
          slug={post.id.replace(/\.md$/, '') || post.id}
        />
      ))}
    </div>
  </section>

  <script>
    const grid = document.getElementById('article-grid');
    const filter = document.getElementById('category-tag-filter');
    if (grid && filter) {
      const cards = grid.querySelectorAll('[data-category]');
      const buttons = filter.querySelectorAll('.tag-btn');

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const tag = (btn as HTMLButtonElement).dataset.tag;
          buttons.forEach((b) => b.setAttribute('data-active', (b as HTMLButtonElement).dataset.tag === tag ? 'true' : 'false'));
          cards.forEach((card) => {
            const tagList = (card.getAttribute('data-tags') || '').split(',');
            const show = !tag || tagList.includes(tag);
            (card as HTMLElement).style.display = show ? '' : 'none';
          });
        });
      });
    }
  </script>
</Layout>

<style>
  .back-link {
    display: inline-block;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .back-link:hover {
    color: var(--accent-hover);
  }

  .page-title {
    margin: 0 0 2rem;
    font-size: 2rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .article-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
